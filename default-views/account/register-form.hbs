<form id="registerForm">
  {{#if error}}
    <div class="row">
      <div class="col s12">
        <p class="text-danger"><strong>{{error}}</strong></p>
      </div>
    </div>
  {{/if}}

  <div class="row">
    <div class="input-field col s6">
      <i class="material-icons prefix">email</i>
      <input type="email" name="email" id="email" placeholder="Email" />
      <label for="email">Recovery Email:</label>
    </div>
    <div class="input-field col s6">
      <p>Your email will only used for account recovery and other
        administrative emails.</p>
    </div>
  </div>

  <div class="row">
    <div class="input-field col s6">
      <i class="material-icons prefix">account_circle</i>
      <input placeholder="Username" id="username" name="username" type="text">
      <label for="username">Display Username:</label>
    </div>
    <div class="input-field col s6">
      <p>Something to display in the nav bar, to indicate you're logged in.</p>
    </div>
  </div>

  <div class="row">
    <div class="input-field col s6">
      <i class="material-icons prefix">vpn_key</i>
      <input id="password" id="password" name="password" type="password">
      <label for="password">Password:</label>
    </div>
  </div>

  <input type="hidden" name="returnToUrl" value="{{returnToUrl}}" />

  <div class="row">
    <div class="col s6 valign-wrapper">
      <button type="submit" class="btn btn-primary" id="registerBtn">Register ></button>

      <div class="loadingio-spinner-gear-kznxtisnhx hide" id="spinner"><div class="ldio-ny0qf724px9">
        <div><div></div><div></div><div></div><div></div><div></div><div></div></div>
      </div></div>

      {{> auth/auth-hidden-fields}}
    </div>

    <div class="col s6" id="loginSection">
      <div>Already have an account?
        <a class="btn btn-xs btn-default"
           href="{{{loginUrl}}}">
          Log In
        </a>
      </div>
    </div>
  </div>

</form>
<script src="/common/js/ready.js"></script>

<script>
  async function submitRegisterForm () {
    document.getElementById('registerBtn').disabled = 'disabled'
    document.getElementById('spinner').classList.remove('hide')
    document.getElementById('loginSection').classList.add('hide')

    const userData = {}
    for (const field of ['email', 'username', 'password']) {
      userData[field] = document.getElementById(field).value
    }

    console.log('Registering:', userData)
    try {
      const response = await fetch('/api/accounts/new', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      })

      if (!response.ok) {
        throw new Error('Error: ' + await response.text())
      }

      console.log(response)
    } catch (e) {
      console.error('Error:', e.message)
    }

  }

  onDocumentReady(() => { // from /common/js/ready.js
    document.getElementById('registerBtn')
      .addEventListener('click', submitRegisterForm)
  })
</script>


